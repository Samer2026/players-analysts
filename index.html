<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التحليل الاحترافي لأداء اللاعبين بالذكاء الاصطناعي</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7fafc;
        }
        .card {
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%234B5563'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            /* Adjust padding and position for RTL */
            padding-left: 1rem;
            padding-right: 3rem; 
            background-position: left 0.75rem center;
            background-size: 1.5rem;
        }
        .spinner {
            border-top-color: #0d9488; /* Teal 600 */
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar style for reports list */
        .reports-list::-webkit-scrollbar {
            width: 8px;
        }
        .reports-list::-webkit-scrollbar-thumb {
            background-color: #5eead4; /* Teal 300 */
            border-radius: 4px;
        }
        .reports-list::-webkit-scrollbar-track {
            background-color: #f0fdfa; /* Teal 50 */
        }
        /* Modal visibility control */
        .modal-show {
            display: flex !important;
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-50 min-h-screen flex justify-center items-start">
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Expose Firebase functions to the global scope for use in the script below
        window.firebase = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            setLogLevel,
            doc,                      
            deleteDoc             
        };
    </script>

    <div class="max-w-4xl w-full bg-white card rounded-2xl p-6 md:p-10 mt-10">
        <!-- Header -->
        <header class="text-center mb-8 border-b pb-4 border-teal-100">
            <h1 class="text-3xl md:text-4xl font-extrabold text-teal-700 mb-2">منصة المحلل الكروي الاحترافي</h1>
            <p class="text-gray-600 text-lg">تحليل مخصص لأدائك بناءً على المركز والمستوى - خدمة التقييم المدفوع</p>
        </header>

        <!-- Current User ID Display -->
        <div class="mb-6 p-3 bg-teal-50 border border-teal-200 rounded-lg text-sm text-teal-800">
            <p class="font-bold mb-1">معرّف المستخدم (للمشاركة):</p>
            <p id="currentUserId" class="text-xs font-mono break-all text-teal-600">جارٍ التحميل...</p>
        </div>

        <!-- Player Data Input Section -->
        <section class="mb-8 p-6 bg-teal-50 rounded-xl border border-teal-200">
            <h2 class="text-xl font-extrabold text-teal-800 mb-6 flex items-center">
                <svg class="w-6 h-6 ml-2 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                الخطوة 1: ملف اللاعب وبيانات الفيديو
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Age Input -->
                <div>
                    <label for="playerAge" class="block text-sm font-medium text-gray-700 mb-2">العمر:</label>
                    <input type="number" id="playerAge" min="5" max="50" placeholder="أدخل العمر" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                </div>
                <!-- Level Select -->
                <div>
                    <label for="playerLevel" class="block text-sm font-medium text-gray-700 mb-2">المستوى:</label>
                    <select id="playerLevel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 custom-select">
                        <option value="">اختر المستوى</option>
                        <option value="مبتدئ">مبتدئ (Beginner)</option>
                        <option value="متوسط">متوسط (Intermediate)</option>
                        <option value="متقدم">متقدم (Advanced)</option>
                    </select>
                </div>
                <!-- Position Select -->
                <div>
                    <label for="playerPosition" class="block text-sm font-medium text-gray-700 mb-2">المركز:</label>
                    <select id="playerPosition" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 custom-select">
                        <option value="">اختر المركز</option>
                        <option value="حارس مرمى">حارس مرمى (Goalkeeper)</option>
                        <option value="دفاع">دفاع (Defender)</option>
                        <option value="وسط">وسط (Midfielder)</option>
                        <option value="جناح">جناح (Wing/Forward)</option>
                        <option value="مهاجم صريح">مهاجم صريح (Striker)</option>
                    </select>
                </div>
                <!-- Footedness Select -->
                <div>
                    <label for="playerFootedness" class="block text-sm font-medium text-gray-700 mb-2">القدم الرئيسية:</label>
                    <select id="playerFootedness" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 custom-select">
                        <option value="">اختر القدم</option>
                        <option value="يمنى">يمنى (Right-footed)</option>
                        <option value="يسرى">يسرى (Left-footed)</option>
                        <option value="كلتا القدمين">كلتا القدمين (Ambidextrous)</option>
                    </select>
                </div>
            </div>
            <!-- Video Link Input -->
            <div class="mb-4">
                <label for="videoLink" class="block text-sm font-medium text-gray-700 mb-2">رابط الفيديو (YouTube/Drive/URL):</label>
                <input type="url" id="videoLink" placeholder="أدخل رابط فيديو الأداء هنا" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500">
            </div>
            <!-- Player Description -->
            <div class="mb-4">
                <label for="playerDescription" class="block text-sm font-medium text-gray-700 mb-2">
                    وصف الأداء في الفيديو (ضروري للتحليل):
                </label>
                <textarea id="playerDescription" rows="4" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="صف نوع التدريب أو المباراة، وأبرز 3 مهارات قمت بأدائها (مثلاً: مراوغة ناجحة، تمريرة طولية دقيقة، أو تصدي صعب)."></textarea>
            </div>
        </section>

        <!-- Payment Simulation and Analysis Button -->
        <section class="mb-8 p-4 bg-green-50 rounded-xl border border-green-200">
            <h2 class="text-xl font-extrabold text-green-700 mb-4 flex items-center">
                <svg class="w-6 h-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                الخطوة 2: طلب التقرير والتحليل
            </h2>
            <div id="purchaseSuccessMessage" class="hidden mb-4 p-3 bg-yellow-100 border border-yellow-400 rounded-lg text-yellow-800 font-bold text-center transition-opacity duration-500">
                ✅ تم تفعيل خدمة التحليل بنجاح! يمكنك الآن إرسال البيانات.
            </div>
            <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 md:space-x-reverse w-full md:w-auto">
                <button id="purchaseBtn" onclick="simulatePurchase()" class="px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition duration-150 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed w-full md:w-1/2">
                    شراء التحليل (10$)
                </button>
                <button id="analyzeBtn" onclick="prepareAnalysis()" disabled class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed w-full md:w-1/2">
                    تحليل الأداء الآن
                </button>
            </div>
        </section>

        <!-- Analysis Output Section (Updated to include Download Button) -->
        <section class="mb-10">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-extrabold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 ml-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    الخطوة 3: تقرير المحلل الآلي الشامل (تقريـرك)
                </h2>
                <button id="downloadReportBtn" class="hidden px-4 py-2 text-sm bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150" onclick="downloadReport()">
                    <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    تنزيل التقرير
                </button>
            </div>
            <div id="analysisOutput" class="min-h-[200px] p-6 bg-gray-50 border-4 border-dashed border-gray-300 rounded-lg text-gray-700">
                <p class="text-center text-gray-500">سيظهر تقرير التحليل المفصل والمخصص هنا بعد إدخال البيانات وشراء الخدمة.</p>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden text-center mt-6">
                <div class="w-12 h-12 border-4 border-gray-200 border-t-4 border-t-teal-500 rounded-full spinner mx-auto"></div>
                <p class="mt-2 text-teal-600 font-medium text-lg">الذكاء الاصطناعي يحلل بيانات اللاعب... يُرجى الانتظار.</p>
            </div>
        </section>

        <!-- Private Reports Section (NEW) -->
        <section class="mb-10 p-6 bg-red-50 rounded-xl border border-red-200">
            <h2 class="text-xl font-extrabold text-red-800 mb-4 flex items-center">
                <svg class="w-6 h-6 ml-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                تقاريري الخاصة (مرئية لك فقط)
            </h2>
            <div id="privateReportsList" class="reports-list max-h-96 overflow-y-auto space-y-4 p-2">
                <p class="text-center text-gray-500">يتم تحميل تقاريرك الخاصة...</p>
            </div>
        </section>

        <!-- Public Reports Section -->
        <section class="p-6 bg-gray-100 rounded-xl border border-gray-300">
            <h2 class="text-xl font-extrabold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 ml-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2v-8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                التقارير العامة التي تم تحليلها (مشاركة عامة)
            </h2>
                        <!-- Filter Controls -->
            <div class="mb-6 p-4 bg-gray-200 rounded-xl flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-grow w-full">
                    <label for="filterPosition" class="block text-sm font-bold text-gray-700 mb-1">تصفية حسب المركز:</label>
                    <select id="filterPosition" class="w-full p-2 border border-gray-400 rounded-lg custom-select text-sm">
                        <option value="الكل">الكل</option>
                        <option value="حارس مرمى">حارس مرمى</option>
                        <option value="دفاع">دفاع</option>
                        <option value="وسط">وسط</option>
                        <option value="جناح">جناح</option>
                        <option value="مهاجم صريح">مهاجم صريح</option>
                    </select>
                </div>
                <div class="flex-grow w-full">
                    <label for="filterLevel" class="block text-sm font-bold text-gray-700 mb-1">تصفية حسب المستوى:</label>
                    <select id="filterLevel" class="w-full p-2 border border-gray-400 rounded-lg custom-select text-sm">
                        <option value="الكل">الكل</option>
                        <option value="مبتدئ">مبتدئ</option>
                        <option value="متوسط">متوسط</option>
                        <option value="متقدم">متقدم</option>
                    </select>
                </div>
                <button onclick="listenForPublicReports()" class="w-full md:w-auto px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">تطبيق المرشحات</button>
            </div>
                        <div id="publicReportsList" class="reports-list max-h-96 overflow-y-auto space-y-4 p-2">
                <p class="text-center text-gray-500">يتم تحميل التقارير...</p>
            </div>
        </section>
    </div>
    <!-- Deletion Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 transition-opacity duration-300" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl p-6 md:p-8 w-full max-w-sm shadow-2xl transform scale-95 transition-transform duration-300" role="alert">
            <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center">
                <svg class="w-6 h-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.39 18c-.77 1.333.192 3 1.732 3z"></path></svg>
                تأكيد الحذف
            </h3>
            <p id="modalMessage" class="text-gray-700 mb-6">هل أنت متأكد من حذف هذا التقرير الخاص؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="flex justify-end space-x-3 space-x-reverse">
                <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">إلغاء</button>
                <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150">حذف</button>
            </div>
        </div>
    </div>
    <script type="module">
        // Import Firebase functions from the window object set up above
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, doc, deleteDoc } = window.firebase;

        // =================================================================
        // Firebase Configuration (Mandatory Setup)
        // =================================================================
        setLogLevel('debug'); // Enable detailed Firebase logs

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const apiKey = ""; // API Key for the Gemini API call
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // Global Firebase variables
        let app, db, auth;
        const PUBLIC_REPORTS_PATH = `artifacts/${appId}/public/data/playerReports`;
        const PRIVATE_REPORTS_COLLECTION = 'privateReports'; 
        let isAuthReady = false;
        let reportIdToDelete = null; // Store ID for confirmation modal

        // State & UI Elements
        let isAnalysisPaid = false;
        const analysisBtn = document.getElementById('analyzeBtn');
        const purchaseBtn = document.getElementById('purchaseBtn');
        const outputDiv = document.getElementById('analysisOutput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const publicReportsList = document.getElementById('publicReportsList');
        const privateReportsList = document.getElementById('privateReportsList'); 
        const currentUserIdDisplay = document.getElementById('currentUserId');
        const deleteModal = document.getElementById('deleteModal'); 
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn'); 
        const purchaseSuccessMessage = document.getElementById('purchaseSuccessMessage'); 
        const downloadBtn = document.getElementById('downloadReportBtn');

        // Input elements (for submission)
        const playerDescription = document.getElementById('playerDescription');
        const playerAge = document.getElementById('playerAge');
        const playerLevel = document.getElementById('playerLevel');
        const playerPosition = document.getElementById('playerPosition');
        const playerFootedness = document.getElementById('playerFootedness');
        const videoLink = document.getElementById('videoLink');

        // Filter elements (for public list)
        const filterPosition = document.getElementById('filterPosition');
        const filterLevel = document.getElementById('filterLevel');
        
        // New variables for Download functionality
        let latestGeneratedText = "";

        /**
         * دالة لتطبيق خاصية التأخير المتزايد لإعادة محاولة الاتصال بالـ API.
         * @param {function} fn - الدالة المراد إعادة محاولتها (عادةً fetch).
         * @param {number} maxRetries - الحد الأقصى لإعادة المحاولات.
         */
        async function withExponentialBackoff(fn, maxRetries = 5) {
            let lastError = null;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fn();
                    if (response.status === 429 || response.status >= 500) {
                        throw new Error(`Server error or rate limit hit: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    lastError = error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            throw lastError;
        }

        /**
         * Simple Markdown to HTML converter for display.
         * @param {string} markdown - Markdown text.
         * @returns {string} - HTML string.
         */
        function markdownToHtml(markdown) {
            // Convert newline to temporary marker before processing
            let html = markdown.replace(/\r\n|\r|\n/g, '@@NEWLINE@@');
            
            // Handle headings
            html = html.replace(/^###\s*(.*?)@@NEWLINE@@/gm, '<h4>$1</h4>');
            html = html.replace(/^##\s*(.*?)@@NEWLINE@@/gm, '<h3>$1</h3>');
            html = html.replace(/^#\s*(.*?)@@NEWLINE@@/gm, '<h2>$1</h2>');

            // Replace bold/strong
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // Handle lists (replace bullet points with <li>)
            html = html.replace(/@@NEWLINE@@\*\s*(.*?)@@NEWLINE@@/g, '<li>$1</li>');
            html = html.replace(/@@NEWLINE@@\-\s*(.*?)@@NEWLINE@@/g, '<li>$1</li>');
            
            // Wrap list items in <ul> or <ol>
            html = html.replace(/(<li>.*?<\/li>)/gms, '<ul>$1</ul>');
            
            // Replace multiple newlines with paragraph tags
            html = html.split('@@NEWLINE@@@@NEWLINE@@').map(p => {
                if (p.trim() === '') return '';
                // If it already starts with a structural tag, don't wrap it
                if (p.trim().startsWith('<h') || p.trim().startsWith('<ul')) {
                    // Remove remaining newlines within a structured block
                    return p.replace(/@@NEWLINE@@/g, '');
                }
                // Otherwise, treat as a paragraph and remove remaining newlines
                return `<p>${p.trim().replace(/@@NEWLINE@@/g, '<br>')}</p>`;
            }).join('');

            return html;
        }


        // =================================================================
        // UI & State Functions
        // =================================================================

        /**
         * تهيئة Firebase والمصادقة وبدء الاستماع للتقارير العامة والخاصة.
         */
        async function setupFirebaseAndListeners() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                const userId = auth.currentUser?.uid || 'N/A';
                currentUserIdDisplay.textContent = userId;
                isAuthReady = true;

                // Set up delete confirmation handler
                confirmDeleteBtn.onclick = executeDelete;

                // Start listening for reports after auth is ready
                listenForPublicReports();
                listenForPrivateReports(); 
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                publicReportsList.innerHTML = `<p class="text-center text-red-500 font-bold">خطأ في الاتصال بقاعدة البيانات.</p>`;
                if (privateReportsList) {
                    privateReportsList.innerHTML = `<p class="text-center text-red-500 font-bold">خطأ في الاتصال بقاعدة البيانات.</p>`;
                }
            }
        }

        /**
         * مسح حقول الإدخال بعد نجاح عملية التحليل.
         */
        function clearInputFields() {
            playerAge.value = '';
            playerLevel.value = '';
            playerPosition.value = '';
            playerFootedness.value = '';
            videoLink.value = '';
            playerDescription.value = '';
        }

        /**
         * تنزيل التقرير الحالي كملف نصي (.txt).
         */
        window.downloadReport = function() {
            if (!latestGeneratedText) {
                console.error("No report text available to download.");
                return;
            }

            const level = playerLevel.value || 'تقرير';
            const position = playerPosition.value || 'لاعب';
            const filename = `تقرير_اللاعب_${position}_${level}.txt`;

            // Create a Blob from the text content
            const blob = new Blob([latestGeneratedText], { type: 'text/plain;charset=utf-8' });

            // Create a temporary link element to trigger the download
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;                        

            // Append to body, click, and remove
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href); // Clean up the URL object
        }

        // =================================================================
        // Payment Simulation (NEW)
        // =================================================================

        /**
         * محاكاة عملية شراء خدمة التحليل.
         */
        window.simulatePurchase = function() {
            if (isAnalysisPaid) return;
            isAnalysisPaid = true;
            purchaseBtn.disabled = true;
            analysisBtn.disabled = false;
            purchaseBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            purchaseBtn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
            purchaseBtn.textContent = 'تم الشراء بنجاح';
            purchaseSuccessMessage.classList.remove('hidden');
            purchaseSuccessMessage.classList.add('opacity-100');
            outputDiv.innerHTML = `<p class="text-center text-teal-600 font-bold">الرجاء إدخال بيانات اللاعب والضغط على "تحليل الأداء الآن".</p>`;
        };

        // =================================================================
        // Analysis Logic (NEW)
        // =================================================================

        /**
         * تجهيز بيانات اللاعب والبدء في التحليل.
         */
        window.prepareAnalysis = function() {
            if (!isAnalysisPaid) {
                outputDiv.innerHTML = '<p class="text-center text-red-500 font-bold">الرجاء شراء خدمة التحليل أولاً.</p>';
                return;
            }
            const data = {
                age: playerAge.value.trim(),
                level: playerLevel.value,
                position: playerPosition.value,
                footedness: playerFootedness.value,
                videoLink: videoLink.value.trim(),
                description: playerDescription.value.trim(),
            };

            const missingFields = Object.keys(data).filter(key => !data[key]);

            if (missingFields.length > 0) {
                outputDiv.innerHTML = `<p class="text-center text-red-500 font-bold">الرجاء إكمال جميع الحقول المطلوبة قبل التحليل.</p>`;
                return;
            }

            fetchAnalysisReport(data);
        };
        
        /**
         * حفظ التقرير في Firestore (خاص وعام).
         * @param {object} playerData - بيانات اللاعب.
         * @param {string} reportText - نص التقرير الذي تم إنشاؤه بواسطة الذكاء الاصطناعي.
         */
        async function saveReport(playerData, reportText) {
            const userId = auth.currentUser?.uid || crypto.randomUUID();
            const timestamp = new Date().toISOString();

            const reportData = {
                ...playerData,
                reportText: reportText,
                userId: userId,
                timestamp: timestamp,
            };
            
            // 1. Save to Private Collection
            const PRIVATE_REPORTS_PATH = `artifacts/${appId}/users/${userId}/${PRIVATE_REPORTS_COLLECTION}`;
            try {
                await addDoc(collection(db, PRIVATE_REPORTS_PATH), reportData);
            } catch (e) {
                console.error("Error saving private report: ", e);
            }

            // 2. Save to Public Collection
            try {
                await addDoc(collection(db, PUBLIC_REPORTS_PATH), reportData);
            } catch (e) {
                console.error("Error saving public report: ", e);
            }
            
            clearInputFields();
        }

        /**
         * التواصل مع Gemini API لإنشاء تقرير التحليل.
         * @param {object} data - بيانات اللاعب المدخلة.
         */
        async function fetchAnalysisReport(data) {
            outputDiv.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            downloadBtn.classList.add('hidden');
            let analysisText = "";

            // System Instruction (Arabic: Professional Football Analyst)
            const systemPrompt = `
            Act as a professional football scout and AI analyst. Provide a detailed, customized report in Arabic based on the provided player data and video description.
            Structure the report clearly using Markdown headings. The analysis must be constructive and focused on technical and tactical aspects relevant to the player's position and level.
            The report MUST include the following three main sections: **نقاط القوة (Strengths)**, **نقاط الضعف ومجالات التحسين (Weaknesses and Areas for Improvement)**, and **توصيات تدريبية مخصصة (Customized Training Recommendations)**.
            `;

            // User Query (Arabic: Player Data)
            const userQuery = `
            **الرجاء إنشاء تقرير تحليل كرة قدم احترافي شامل باللغة العربية بناءً على البيانات التالية:**
            * **العمر:** ${data.age} سنة
            * **المستوى:** ${data.level}
            * **المركز:** ${data.position}
            * **القدم الرئيسية:** ${data.footedness}
            * **رابط الفيديو (للمرجعية):** ${data.videoLink}
            * **وصف الأداء الذي تمت مشاهدته:** ${data.description}

            قم بتنسيق التقرير باستخدام Markdown.
            `;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Use Google Search for grounding
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const fetchFunction = () => fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const response = await withExponentialBackoff(fetchFunction);
                const result = await response.json();
                
                analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (analysisText) {
                    // Update UI with the generated report
                    outputDiv.innerHTML = `<h3 class="text-xl font-bold text-teal-700 mb-3">التقرير النهائي</h3><hr class="mb-3"/>${markdownToHtml(analysisText)}`;
                    latestGeneratedText = analysisText; // Store for download
                    downloadBtn.classList.remove('hidden');
                    
                    // Save to Firestore
                    await saveReport(data, analysisText);
                    outputDiv.insertAdjacentHTML('beforeend', '<p class="text-sm font-bold mt-4 text-green-600">✅ تم حفظ التقرير في قائمة تقاريرك الخاصة والتقارير العامة!</p>');
                } else {
                    console.error("Gemini API Error: No text generated.", result);
                    outputDiv.innerHTML = `<p class="text-center text-red-500 font-bold">فشل التحليل. لم يستجب الذكاء الاصطناعي بنص صالح.</p>`;
                }
            } catch (error) {
                console.error("API Call Failed:", error);
                outputDiv.innerHTML = `<p class="text-center text-red-500 font-bold">خطأ في الاتصال بخدمة التحليل: ${error.message}</p>`;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // =================================================================
        // Firestore Listener Functions (User's original listeners)
        // =================================================================

        /**
         * الاستماع في الوقت الحقيقي للتقارير العامة في Firestore وتطبيق الفلاتر محليًا.
         */
        function listenForPublicReports() {
            if (!isAuthReady) return;

            publicReportsList.innerHTML = '<p class="text-center text-gray-500">جاري تحميل التقارير...</p>';

            // 1. Get filter values
            const selectedPosition = filterPosition.value;
            const selectedLevel = filterLevel.value;

            const q = query(collection(db, PUBLIC_REPORTS_PATH));                        
            onSnapshot(q, (snapshot) => {
                let reports = [];                                
                snapshot.forEach((doc) => {
                    reports.push(doc.data());
                });

                // 2. Apply Filtering (Client-side)
                let filteredReports = reports.filter(report => {
                    const positionMatch = (selectedPosition === 'الكل' || report.position === selectedPosition);
                    const levelMatch = (selectedLevel === 'الكل' || report.level === selectedLevel);
                    return positionMatch && levelMatch;
                });

                // 3. Sort by timestamp (most recent first)
                filteredReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // 4. Render the list
                renderPublicReports(filteredReports);

            }, (error) => {
                console.error("Firestore Public Listen Error:", error);
                publicReportsList.innerHTML = `<p class="text-center text-red-500 font-bold">خطأ في جلب التقارير العامة.</p>`;
            });
        }

        /**
         * دالة لعرض قائمة التقارير العامة.
         */
        function renderPublicReports(reports) {
            publicReportsList.innerHTML = '';

            if (reports.length === 0) {
                publicReportsList.innerHTML = '<p class="text-center text-gray-500 font-bold">لم يتم العثور على تقارير مطابقة للمعايير المحددة.</p>';
                return;
            }

            reports.forEach((report, index) => {
                const reportElement = `
                    <div class="p-4 bg-white rounded-lg shadow-md border-r-4 border-blue-500">
                        <p class="text-lg font-bold text-gray-800">تقرير: ${report.position} - (${report.level})</p>
                        <p class="text-sm text-gray-600 mt-1">
                            <span class="font-semibold ml-2">العمر:</span> ${report.age} سنة |                             
                            <span class="font-semibold ml-2">القدم:</span> ${report.footedness}
                        </p>
                        <p class="text-sm text-gray-500 break-all">تم التحليل بواسطة: <span class="font-mono text-xs">${report.userId.substring(0, 8)}...</span></p>
                        <details class="mt-3">
                            <summary class="font-semibold text-blue-600 cursor-pointer hover:text-blue-700 transition">عرض التقرير المفصل</summary>
                            <div class="mt-2 p-3 bg-blue-50 rounded-md border border-blue-200 text-sm max-h-40 overflow-y-auto">
                                <strong class="block mb-1 text-blue-800">ملخص الوصف:</strong>
                                <p class="text-gray-700 italic">${report.description.substring(0, 150)}...</p>
                                <strong class="block mt-3 mb-1 text-blue-800">بداية التقرير:</strong>
                                <div class="text-gray-700">${report.reportText.substring(0, 300)}...</div>
                                <a href="${report.videoLink}" target="_blank" class="text-xs text-teal-500 block mt-2 hover:underline">مشاهدة رابط الفيديو</a>
                            </div>
                        </details>
                    </div>
                `;
                publicReportsList.insertAdjacentHTML('beforeend', reportElement);
            });
        }

        /**
         * الاستماع في الوقت الحقيقي للتقارير الخاصة بالمستخدم الحالي.
         */
        function listenForPrivateReports() {
            if (!isAuthReady || !auth.currentUser?.uid) {
                privateReportsList.innerHTML = '<p class="text-center text-gray-500">الرجاء الانتظار حتى يتم تحميل ملفك الشخصي لعرض التقارير الخاصة.</p>';
                return;
            }

            const userId = auth.currentUser.uid;
            // Path: artifacts/{appId}/users/{userId}/privateReports
            const PRIVATE_REPORTS_PATH = `artifacts/${appId}/users/${userId}/${PRIVATE_REPORTS_COLLECTION}`;

            const q = query(collection(db, PRIVATE_REPORTS_PATH));                        
            onSnapshot(q, (snapshot) => {
                let reports = [];
                snapshot.forEach((doc) => {
                    // IMPORTANT: Include doc.id for deletion functionality
                    reports.push({ ...doc.data(), id: doc.id }); 
                });

                // Sort by timestamp (most recent first)
                reports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Render the list using a dedicated function
                renderPrivateReports(reports);

            }, (error) => {
                console.error("Firestore Private Listen Error:", error);
                privateReportsList.innerHTML = `<p class="text-center text-red-500 font-bold">خطأ في جلب تقاريرك الخاصة.</p>`;
            });
        }

        /**
         * دالة لعرض قائمة التقارير الخاصة.
         */
        function renderPrivateReports(reports) {
            privateReportsList.innerHTML = '';

            if (reports.length === 0) {
                privateReportsList.innerHTML = '<p class="text-center text-gray-500 font-bold">لم تقم بتحليل أي تقارير خاصة بعد.</p>';
                return;
            }

            reports.forEach((report) => {
                const reportElement = `
                    <div class="p-4 bg-white rounded-lg shadow-md border-r-4 border-red-500 flex justify-between items-start">
                        <!-- Report Info -->
                        <div class="flex-grow">
                            <p class="text-lg font-bold text-gray-800">تقرير: ${report.position} - (${report.level})</p>
                            <p class="text-sm text-gray-600 mt-1">
                                <span class="font-semibold ml-2">العمر:</span> ${report.age} سنة |
                                 <span class="font-semibold ml-2">القدم:</span> ${report.footedness}
                            </p>
                            <details class="mt-3">
                                <summary class="font-semibold text-red-600 cursor-pointer hover:text-red-700 transition">عرض التقرير المفصل</summary>
                                <div class="mt-2 p-3 bg-red-50 rounded-md border border-red-200 text-sm max-h-40 overflow-y-auto">
                                    <strong class="block mb-1 text-red-800">ملخص الوصف:</strong>
                                    <p class="text-gray-700 italic">${report.description.substring(0, 150)}...</p>
                                    <strong class="block mt-3 mb-1 text-red-800">بداية التقرير:</strong>
                                    <div class="text-gray-700">${report.reportText.substring(0, 300)}...</div>
                                    <a href="${report.videoLink}" target="_blank" class="text-xs text-teal-500 block mt-2 hover:underline">مشاهدة رابط الفيديو</a>
                                </div>
                            </details>
                        </div>
                                                <!-- Delete Button (NEW) -->
                        <button onclick="showDeleteModal('${report.id}')" class="flex-shrink-0 mr-4 p-2 text-white bg-red-500 rounded-full hover:bg-red-600 transition duration-150 transform hover:scale-105" aria-label="حذف التقرير">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                privateReportsList.insertAdjacentHTML('beforeend', reportElement);
            });
        }

        /**
         * عرض نافذة التأكيد قبل الحذف.
         * @param {string} reportId - معرّف التقرير المراد حذفه.
         */
        window.showDeleteModal = function(reportId) {
            reportIdToDelete = reportId;
            deleteModal.classList.add('modal-show');
        }

        /**
         * إخفاء نافذة التأكيد.
         */
        window.closeDeleteModal = function() {
            reportIdToDelete = null;
            deleteModal.classList.remove('modal-show');
        }

        /**
         * تنفيذ عملية الحذف الفعلية من Firestore.
         */
        async function executeDelete() {
            if (!reportIdToDelete || !auth.currentUser?.uid) {
                closeDeleteModal();
                console.error("Attempted to delete report without valid ID or user auth.");
                return;
            }

            const userId = auth.currentUser.uid;
            const docId = reportIdToDelete;
            const PRIVATE_REPORTS_PATH = `artifacts/${appId}/users/${userId}/${PRIVATE_REPORTS_COLLECTION}`;                        
            // Construct document reference
            const reportRef = doc(db, PRIVATE_REPORTS_PATH, docId);                        
            closeDeleteModal(); // Close modal immediately

            try {
                await deleteDoc(reportRef);
                // Success is handled by onSnapshot listener automatically
                outputDiv.innerHTML = `<p class="text-center text-green-600 font-bold">تم حذف التقرير بنجاح من قائمة تقاريرك الخاصة.</p>`;
            } catch (error) {
                console.error("Error deleting document: ", error);
                outputDiv.innerHTML = `<p class="text-center text-red-600 font-bold">فشل حذف التقرير. يرجى مراجعة سجلات الخطأ.</p>`;
            }
        }
        
        // =================================================================
        // Initialize App
        // =================================================================
        window.onload = setupFirebaseAndListeners;
    </script>
</body>
</html>
