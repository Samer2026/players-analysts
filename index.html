<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title Modified -->
    <title>كيف تصبح لاعب كرة قدم محترف</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Lucide Icons for better UI -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
        }
        .container-card {
            background-color: #2d3748; /* Slightly lighter dark card */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        .upload-box {
            border: 2px dashed #4a5568;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .upload-box:hover {
            border-color: #4299e1;
            background-color: #2c3545;
        }
        .rtl-input {
            text-align: right;
        }
        .rating-input {
            appearance: none;
            -moz-appearance: textfield;
            text-align: center;
        }
        .rating-input::-webkit-inner-spin-button, 
        .rating-input::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        .tab-button.active {
            background-color: #4299e1;
            color: white;
            box-shadow: 0 4px 6px rgba(66, 153, 225, 0.3);
        }
        .tab-button {
            transition: all 0.2s;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex justify-center items-start">

    <div id="appContainer" class="w-full max-w-6xl container-card rounded-xl p-6 sm:p-8 my-8 relative">

        <!-- Added 'Created By' Tag - Color changed to Red (text-red-400) -->
        <div class="absolute top-4 right-4 text-xs font-semibold text-red-400 bg-gray-700 px-3 py-1 rounded-full shadow-md">
            Created By samir-Q
        </div>
        
        <!-- H1 Modified to "كيف تصبح لاعب كرة قدم محترف" -->
        <div class="flex items-center justify-center mb-4 border-b border-gray-700 pb-4">
            <h1 class="text-4xl font-extrabold text-white text-center">
                <i data-lucide="football" class="w-8 h-8 inline text-yellow-400 align-middle ml-3"></i>
                كيف تصبح لاعب كرة قدم محترف
                <i data-lucide="football" class="w-8 h-8 inline text-yellow-400 align-middle mr-3"></i>
            </h1>
        </div>
        <p class="text-md text-gray-400 text-center mb-8">
            قم بتحليل أداء اللاعبين بدقة عبر الفيديو باستخدام نموذج Gemini.
        </p>

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap justify-center gap-4 mb-8 p-3 bg-gray-700 rounded-xl">
            <button id="tab-single-analysis" onclick="showTab('single-analysis')" class="tab-button active flex items-center px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold">
                <i data-lucide="video" class="w-5 h-5 ml-2"></i> تحليل الفيديو الفردي
            </button>
            <button id="tab-comparison" onclick="showTab('comparison')" class="tab-button flex items-center px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-600 hover:text-white font-semibold">
                <i data-lucide="scale" class="w-5 h-5 ml-2"></i> مقارنة الأداء (قريباً)
            </button>
            <button id="tab-reports" onclick="showTab('reports')" class="tab-button flex items-center px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-600 hover:text-white font-semibold">
                <i data-lucide="clipboard-list" class="w-5 h-5 ml-2"></i> التقارير والملخصات (قريباً)
            </button>
        </div>

        <!-- Single Analysis Tab Content -->
        <div id="single-analysis" class="tab-content">
            <!-- بيانات اللاعب -->
            <h2 class="text-2xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">1. بيانات اللاعب الأساسية</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div>
                    <label for="playerName" class="block text-sm font-medium text-gray-300 mb-1">اسم اللاعب:</label>
                    <input type="text" id="playerName" value="راشد" class="rtl-input w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500" placeholder="مثال: راشد">
                </div>
                <div>
                    <label for="playerAge" class="block text-sm font-medium text-gray-300 mb-1">العمر:</label>
                    <input type="number" id="playerAge" class="rtl-input w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500" placeholder="مثال: 25">
                </div>
                <div>
                    <label for="playerPosition" class="block text-sm font-medium text-gray-300 mb-1">المركز (Position):</label>
                    <input type="text" id="playerPosition" class="rtl-input w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500" placeholder="مثال: مهاجم / خط الوسط">
                </div>
            </div>
            
            <!-- التقييم الأولي -->
            <h2 class="text-2xl font-semibold text-white mb-4 border-b border-gray-600 pb-2 flex items-center">
                 <i data-lucide="star" class="w-5 h-5 ml-2 text-yellow-400"></i> 2. التقييم الأولي للأداء (من 10)
            </h2>
            <p class="text-sm text-gray-400 mb-4">أدخل تقييمك المبدئي لمهارات اللاعب. سيستخدم النموذج هذه العلامات كمعيار أولي للتحليل.</p>

            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8 text-center">
                <!-- Skill 1: Passing -->
                <div class="bg-gray-700 p-3 rounded-lg">
                    <label for="playerRatingPassing" class="block text-sm font-medium text-gray-300 mb-1">التمرير</label>
                    <input type="number" id="playerRatingPassing" min="1" max="10" class="rating-input w-full p-2 rounded-lg bg-gray-800 text-white font-bold text-xl focus:ring-blue-500 focus:border-blue-500" placeholder="5" value="">
                </div>
                 <!-- Skill 2: Shooting -->
                <div class="bg-gray-700 p-3 rounded-lg">
                    <label for="playerRatingShooting" class="block text-sm font-medium text-gray-300 mb-1">التسديد</label>
                    <input type="number" id="playerRatingShooting" min="1" max="10" class="rating-input w-full p-2 rounded-lg bg-gray-800 text-white font-bold text-xl focus:ring-blue-500 focus:border-blue-500" placeholder="5" value="">
                </div>
                 <!-- Skill 3: Dribbling -->
                <div class="bg-gray-700 p-3 rounded-lg">
                    <label for="playerRatingDribbling" class="block text-sm font-medium text-gray-300 mb-1">المراوغة</label>
                    <input type="number" id="playerRatingDribbling" min="1" max="10" class="rating-input w-full p-2 rounded-lg bg-gray-800 text-white font-bold text-xl focus:ring-blue-500 focus:border-blue-500" placeholder="5" value="">
                </div>
                 <!-- Skill 4: Movement -->
                <div class="bg-gray-700 p-3 rounded-lg">
                    <label for="playerRatingMovement" class="block text-sm font-medium text-gray-300 mb-1">التحرك (بدون كرة)</label>
                    <input type="number" id="playerRatingMovement" min="1" max="10" class="rating-input w-full p-2 rounded-lg bg-gray-800 text-white font-bold text-xl focus:ring-blue-500 focus:border-blue-500" placeholder="5" value="">
                </div>
                 <!-- Skill 5: Physicality -->
                <div class="bg-gray-700 p-3 rounded-lg">
                    <label for="playerRatingPhysicality" class="block text-sm font-medium text-gray-300 mb-1">القدرة البدنية</label>
                    <input type="number" id="playerRatingPhysicality" min="1" max="10" class="rating-input w-full p-2 rounded-lg bg-gray-800 text-white font-bold text-xl focus:ring-blue-500 focus:border-blue-500" placeholder="5" value="">
                </div>
            </div>


            <!-- Video Upload Input -->
            <h2 class="text-2xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">3. تحميل الفيديو</h2>
            <div id="uploadContainer" class="w-full flex justify-center mb-8">
                <label for="videoFile" class="upload-box w-full max-w-lg h-40 flex flex-col justify-center items-center text-gray-400 rounded-lg">
                    <svg class="w-10 h-10 mb-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span class="text-lg font-semibold">اضغط هنا لرفع الفيديو</span>
                    <span class="text-xs text-gray-500 mt-1">يُفضل استخدام مقاطع قصيرة للحصول على نتائج أسرع</span>
                    <input type="file" id="videoFile" accept="video/*" class="hidden" onchange="handleVideoUpload(event)">
                </label>
            </div>

            <!-- Video Player and Analysis Section (Hidden until video is uploaded) -->
            <div id="analysisSection" class="hidden">
                
                <!-- Video Player -->
                <div class="bg-black rounded-lg overflow-hidden mb-6">
                    <video id="videoPlayer" class="w-full h-auto" controls></video>
                </div>

                <!-- Analysis Input -->
                <h2 class="text-2xl font-semibold text-white mb-4 border-b border-gray-600 pb-2">4. تفاصيل التحليل المطلوب</h2>
                
                <!-- AI / MOCK TOGGLE SECTION -->
                <div id="analysisModeCard" class="p-4 mb-4 bg-gray-800 rounded-xl border border-blue-500/50 flex flex-col sm:flex-row items-start sm:items-center justify-between transition duration-300">
                    <div class="flex items-center mb-2 sm:mb-0">
                        <!-- Renamed to aiAnalysisToggle -->
                        <input type="checkbox" id="aiAnalysisToggle" checked class="w-5 h-5 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 cursor-pointer" onchange="updateAnalysisMode()">
                        <label for="aiAnalysisToggle" class="mr-3 text-lg font-bold text-gray-300 cursor-pointer select-none">
                            تفعيل التحليل المدعوم بالذكاء الاصطناعي (Gemini AI):
                        </label>
                    </div>
                    <!-- Display current mode and fee -->
                    <span id="analysisModeText" class="font-extrabold text-xl text-green-400 flex items-center">
                        <span class="text-white text-2xl mr-2">احترافي (+10$)</span> <i data-lucide="dollar-sign" class="w-5 h-5 text-green-400"></i>
                    </span>
                </div>
                <!-- END AI / MOCK TOGGLE SECTION -->

                <div class="space-y-4">
                    <textarea id="analysisPrompt" rows="4" class="rtl-input w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500" placeholder="صف الأداء الذي تريد تحليله (على سبيل المثال: 'حلل حركة أقدام اللاعب وموقعه الدفاعي خلال آخر 30 ثانية من هذا المقطع.')."></textarea>
                    
                    <button onclick="runAnalysis()" id="analyzeButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                        <i data-lucide="cpu" class="w-5 h-5 ml-2 inline"></i> بدء التحليل الذكي (احترافي +10$)
                    </button>
                </div>
                
                <!-- Analysis Result Area -->
                <div class="mt-8 p-4 sm:p-6 bg-gray-700 rounded-xl border border-blue-500">
                    <h3 class="text-xl font-semibold text-blue-400 mb-3 flex items-center">
                        <i data-lucide="file-text" class="w-5 h-5 ml-2"></i> نتائج التقييم والتحليل
                    </h3>
                    <p id="resultText" class="text-gray-300 italic whitespace-pre-wrap">
                        <strong class="text-red-400">تنبيه:</strong> التحليل التجريبي السريع جاهز! جرب تبديل خيار التحليل أعلاه.
                    </p>
                </div>
                
                <!-- Hidden Loading Indicator -->
                <div id="loadingIndicator" class="hidden text-center mt-4">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                    <p class="text-blue-400 mt-2">جاري التحليل... قد يستغرق الأمر بعض الوقت لمعالجة الفيديو.</p>
                </div>

            </div>
        </div>
        
        <!-- Comparison Tab Content (Hidden by default) -->
        <div id="comparison" class="tab-content hidden">
             <div class="p-8 text-center bg-gray-700 rounded-xl">
                <i data-lucide="scale" class="w-12 h-12 mx-auto text-blue-400 mb-4"></i>
                <h2 class="text-3xl font-bold text-white mb-3">ميزة مقارنة الأداء (قريباً)</h2>
                <p class="text-gray-400">ستسمح لك هذه الميزة برفع مقطعين فيديو للاعبين مختلفين أو لنفس اللاعب في فترات مختلفة، والحصول على تقرير مقارن مفصل يحدد نقاط القوة والضعف لكل أداء.</p>
            </div>
        </div>

        <!-- Reports Tab Content (Hidden by default) -->
        <div id="reports" class="tab-content hidden">
            <div class="p-8 text-center bg-gray-700 rounded-xl">
                <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto text-blue-400 mb-4"></i>
                <h2 class="text-3xl font-bold text-white mb-3">ميزة التقارير والملخصات (قريباً)</h2>
                <p class="text-gray-400">ستوفر هذه الميزة ملخصات ولوحات قيادة (Dashboards) لجميع التحليلات التي قمت بتنفيذها، مع إمكانية تصدير تقارير تدريبية شاملة.</p>
            </div>
        </div>

        <!-- Deployment Guide Section -->
        <div class="mt-12 pt-6 border-t border-gray-700">
            <button onclick="toggleGuide()" class="flex justify-between items-center w-full text-lg font-semibold text-blue-400 hover:text-blue-300 transition duration-150 p-2 rounded-lg bg-gray-700">
                <span>عرض دليل النشر والمشاركة</span>
                <svg id="guideToggleIcon" class="w-5 h-5 transform rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>

            <div id="deploymentGuide" class="guide-content text-gray-300 mt-4 p-4 bg-gray-800 rounded-lg hidden">
                <h1 class="text-2xl font-bold text-white mb-4">دليل جعل مشروعك متاحاً للجمهور على الإنترنت</h1>
                <p class="mb-4">يتضمن نشر المحتوى عبر الإنترنت استضافة ملفاتك على خادم يمكن للجمهور الوصول إليه. لمعظم المشاريع الحديثة، خاصة المواقع والتطبيقات البسيطة، لا تحتاج عادةً إلى خادم معقد ومكلف.</p>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide Icons
        window.onload = function() {
            lucide.createIcons();
            // Ensure the correct tab is shown on load
            showTab('single-analysis');
            // Set initial state of the analysis mode
            updateAnalysisMode();
        }

        // --- SPA Navigation Logic ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'bg-blue-600', 'hover:bg-blue-700', 'text-white');
                button.classList.add('text-gray-300', 'hover:bg-gray-600', 'hover:text-white');
            });

            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('active', 'bg-blue-600', 'hover:bg-blue-700', 'text-white');
            document.getElementById(`tab-${tabId}`).classList.remove('text-gray-300', 'hover:bg-gray-600', 'hover:text-white');

            lucide.createIcons();
        }


        // --- Analysis Logic and API Call ---
        // ****** يجب وضع مفتاح API الخاص بك هنا ******
        const apiKey = ""; 
        const modelName = 'gemini-2.5-flash-preview-05-20';

        function toggleGuide() {
            const guide = document.getElementById('deploymentGuide');
            const icon = document.getElementById('guideToggleIcon');
            
            guide.classList.toggle('hidden');
            
            if (guide.classList.contains('hidden')) {
                icon.classList.remove('rotate-180');
                icon.classList.add('rotate-0');
            } else {
                icon.classList.remove('rotate-0');
                icon.classList.add('rotate-180');
            }
        }
        
        function updateAnalysisMode() {
            const isAIEnabled = document.getElementById('aiAnalysisToggle').checked;
            const modeTextSpan = document.getElementById('analysisModeText');
            const analyzeButton = document.getElementById('analyzeButton');
            const modeCard = document.getElementById('analysisModeCard');
            
            if (isAIEnabled) {
                // AI Mode (Can include fee logic)
                modeTextSpan.innerHTML = '<span class="text-white text-2xl mr-2">احترافي (+10$)</span> <i data-lucide="dollar-sign" class="w-5 h-5 text-green-400"></i>';
                analyzeButton.innerHTML = '<i data-lucide="cpu" class="w-5 h-5 ml-2 inline"></i> بدء التحليل الذكي (احترافي +10$)';
                modeCard.classList.remove('border-red-500/50');
                modeCard.classList.add('border-blue-500/50');
                modeTextSpan.classList.add('text-green-400');
                modeTextSpan.classList.remove('text-red-400');
            } else {
                // Mock Mode (Free and Fast)
                modeTextSpan.innerHTML = '<span class="text-red-400 text-2xl mr-2">تجريبي (مجاني)</span> <i data-lucide="alert-triangle" class="w-5 h-5 text-red-400"></i>';
                analyzeButton.innerHTML = '<i data-lucide="zap" class="w-5 h-5 ml-2 inline"></i> بدء التحليل التجريبي السريع (Mock)';
                modeCard.classList.remove('border-blue-500/50');
                modeCard.classList.add('border-red-500/50');
                modeTextSpan.classList.remove('text-green-400');
                modeTextSpan.classList.add('text-red-400');
            }
            lucide.createIcons();
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve(base64Data);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function handleVideoUpload(event) {
            const file = event.target.files[0];
            const videoPlayer = document.getElementById('videoPlayer');
            const analysisSection = document.getElementById('analysisSection');
            const uploadContainer = document.getElementById('uploadContainer');
            const resultText = document.getElementById('resultText');

            if (file) {
                const videoUrl = URL.createObjectURL(file);
                videoPlayer.src = videoUrl;
                
                videoPlayer.classList.remove('hidden');
                analysisSection.classList.remove('hidden');
                uploadContainer.classList.add('hidden'); 

                resultText.innerText = 'تم تحميل الفيديو بنجاح. أدخل التقييم الأولي وصف الأداء في المربع أعلاه واضغط على زر التحليل.';
                resultText.classList.remove('text-red-400');

                window.uploadedVideoFile = file;
            }
        }

        // Mock Analysis function to return a predefined response
        function getMockAnalysis(playerName) {
            return `**تقرير تحليل تجريبي سريع (تحليل وهمي)**

هذا التقرير هو تحليل وهمي تم إنشاؤه محلياً ولا يعتمد على الذكاء الاصطناعي لتحليل الفيديو المرفوع. يتم عرض هذا التقرير لأنك اخترت وضع "التحليل التجريبي السريع".

---

**ملاحظات الأداء العامة لـ ${playerName || 'اللاعب'}:**
* **القوة:** يظهر ${playerName || 'اللاعب'} تحكماً جيداً في الكرة في المناطق المزدحمة ووعياً تكتيكياً جيداً في الثلث الدفاعي.
* **نقطة للتحسين:** يحتاج إلى اتخاذ قرارات أسرع بخصوص التمريرة النهائية (Final Pass) لزيادة الفعالية الهجومية.

**التقييمات المعدلة بناءً على التحليل الوهمي:**
* **التمرير:** 7/10 
* **التسديد:** 6/10 
* **المراوغة:** 8/10 
* **التحرك:** 7/10 
* **القدرة البدنية:** 8/10

**التوصية:** التركيز على تدريبات الرؤية المحيطية والتحول السريع من الدفاع للهجوم، والعمل على دقة التسديد من خارج منطقة الجزاء.`;
        }

        async function runAnalysis() {
            const isAIEnabled = document.getElementById('aiAnalysisToggle').checked;
            const prompt = document.getElementById('analysisPrompt').value.trim();
            const playerName = document.getElementById('playerName').value.trim();
            const playerAge = document.getElementById('playerAge').value.trim();
            const playerPosition = document.getElementById('playerPosition').value.trim();
            
            // UI Elements
            const resultText = document.getElementById('resultText');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const analyzeButton = document.getElementById('analyzeButton');
            
            resultText.classList.remove('text-red-400');

            // --- التحقق من المدخلات الأساسية ---
            if (!window.uploadedVideoFile) {
                resultText.innerText = 'الرجاء رفع ملف فيديو أولاً.';
                resultText.classList.add('text-red-400');
                return;
            }

            if (prompt === "") {
                resultText.innerText = 'الرجاء إدخال وصف أو سؤال حول الأداء.';
                resultText.classList.add('text-red-400');
                return;
            }

            // --- LOGIC SPLIT: MOCK ANALYSIS ---
            if (!isAIEnabled) {
                // Run Mock Analysis instantly
                analyzeButton.disabled = true;
                loadingIndicator.classList.remove('hidden');
                resultText.innerText = 'جاري إعداد التحليل التجريبي...';

                // Simulate a very short loading time (e.g., 500ms)
                await new Promise(resolve => setTimeout(resolve, 500)); 

                resultText.innerText = getMockAnalysis(playerName);
                loadingIndicator.classList.add('hidden');
                analyzeButton.disabled = false;
                resultText.classList.remove('text-red-400');
                resultText.classList.add('text-gray-300');
                return; // Exit the function after mock analysis
            }
            
            // --- LOGIC SPLIT: AI ANALYSIS (Proceed with API Call) ---

            // ***** التحقق من مفتاح API لنموذج الذكاء الاصطناعي *****
            if (apiKey === "") {
                const apiError = `خطأ في المصادقة: لا يمكن إجراء التحليل بالذكاء الاصطناعي. يجب وضع مفتاح Gemini API صالح في متغير 'apiKey' لتفعيل تحليل الفيديو.`;
                console.error(apiError);
                resultText.innerText = apiError;
                resultText.classList.add('text-red-400');
                return;
            }
            // *******************************************************
            
            // Collect Ratings
            const ratingPassing = document.getElementById('playerRatingPassing').value || 'لم يُقيّم';
            const ratingShooting = document.getElementById('playerRatingShooting').value || 'لم يُقيّم';
            const ratingDribbling = document.getElementById('playerRatingDribbling').value || 'لم يُقيّم';
            const ratingMovement = document.getElementById('playerRatingMovement').value || 'لم يُقيّم';
            const ratingPhysicality = document.getElementById('playerRatingPhysicality').value || 'لم يُقيّم';

            // --- بناء محتوى التحليل لنموذج AI ---
            const playerDetails = `
تفاصيل اللاعب:
- الاسم: ${playerName || 'غير محدد'}
- العمر: ${playerAge || 'غير محدد'}
- المركز: ${playerPosition || 'غير محدد'}
`;

            const playerRatings = `
التقييم الأولي للاعب (تقييمك الذاتي/تقييم المدرب من 10):
- التمرير (Passing): ${ratingPassing}
- التسديد (Shooting): ${ratingShooting}
- المراوغة (Dribbling): ${ratingDribbling}
- التحرك بدون كرة (Off-Ball Movement): ${ratingMovement}
- القدرة البدنية (Physicality): ${ratingPhysicality}
`;
            
            // The AI mode is tied to the Professional Tier/Fee logic.
            const analystNote = `ملاحظة للمحلل: تم دفع رسوم قدرها 10 دولارات لهذا التحليل الاحترافي. يرجى ضمان جودة عالية ودقة استثنائية في التقرير (Professional Paid Tier).`;
            
            const fullPrompt = `استنادًا إلى البيانات التالية، يرجى الأخذ في الاعتبار هذا التقييم الأولي أثناء تحليل مقطع الفيديو. قم بتحليل الفيديو بدقة، وإذا كانت العلامات الأولية لا تتطابق مع ما تراه في المقطع، قدم تفسيراً لماذا. قم بتأكيد أو تعديل هذا التقييم في تقريرك النهائي بناءً على ما تراه في المقطع.

${playerDetails}
${playerRatings}

التحليل المطلوب: ${prompt}

${analystNote}`;
            
            // --- بدء عملية التحليل والتحميل لنموذج AI ---
            loadingIndicator.classList.remove('hidden');
            analyzeButton.disabled = true;
            resultText.innerText = 'جاري إعداد التحليل... قد يستغرق الأمر بعض الوقت لمعالجة الفيديو.';


            try {
                const base64Data = await fileToBase64(window.uploadedVideoFile);
                const mimeType = window.uploadedVideoFile.type;

                // استخدام API URL
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                
                // System prompt ensures high-quality Arabic output as a professional analyst.
                const systemPrompt = "You are a world-class professional sports analyst, specializing in video motion and tactical review. Provide a detailed, highly structured, and professional analysis based on the user's prompt, provided player data, and initial performance ratings. The analysis must explicitly address the initial ratings provided by the user, either confirming them or adjusting them based on the video evidence. Use clear headings and bullet points. **The entire response must be in fluent, professional Arabic.**";

                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: fullPrompt }, 
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64Data
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                let response = null;
                let result = null;
                
                // Exponential backoff for retries
                for (let i = 0; i < 3; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        // Check for rate limiting (429) or temporary server errors (500, 503)
                        if (response.status !== 429 && response.status < 500) break; 
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    } catch (e) {
                        if (i === 2) throw e;
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }
                
                if (!response || !response.ok) {
                    const errorText = await response.text();
                    console.error("API Error Response:", errorText);
                    
                    if (response.status === 401) {
                         throw new Error(`خطأ 401: فشلت المصادقة. يرجى التأكد من أن المفتاح صحيح ومحقون في الكود.`);
                    } else {
                         throw new Error(`فشل استدعاء API بحالة: ${response.status}`);
                    }
                }
                
                result = await response.json();

                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    resultText.innerText = generatedText;
                    resultText.classList.remove('text-red-400');
                    resultText.classList.add('text-gray-300');
                } else {
                    resultText.innerText = 'عذراً، فشل توليد التحليل. يرجى التأكد من وضوح الفيديو وإعادة المحاولة.';
                    resultText.classList.add('text-red-400');
                }

            } catch (error) {
                console.error("Analysis Error:", error);
                
                let errorMessage = `حدث خطأ أثناء التحليل بالذكاء الاصطناعي: ${error.message}.`;
                
                if (error.message.includes('401')) {
                    errorMessage = 'خطأ في المصادقة (401): لا يمكن إجراء التحليل بالذكاء الاصطناعي. يرجى وضع مفتاح API صالح.';
                } else if (error.message.includes('400')) {
                    errorMessage = 'خطأ 400: عذراً، قد يكون حجم الفيديو كبيراً جداً أو تنسيقه غير مدعوم من قبل نموذج التحليل. يرجى محاولة استخدام مقطع أقصر.';
                }

                resultText.innerText = errorMessage;
                resultText.classList.add('text-red-400');
            } finally {
                loadingIndicator.classList.add('hidden');
                analyzeButton.disabled = false;
            }
        }
    </script>
</body>
</html>
